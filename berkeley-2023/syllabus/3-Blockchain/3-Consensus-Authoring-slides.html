<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Consensus Authoring</title>
  <link rel="shortcut icon" href="./../../assets/favicon.ico" />
  <link rel="stylesheet" href="./../../dist/reset.css" />
  <link rel="stylesheet" href="./../../dist/reveal.css" />
  <link rel="stylesheet" href="./../../assets/styles/PBA-theme.css" id="theme" />
  <link rel="stylesheet" href="./../../css/highlight/shades-of-purple.css" />

  <link rel="stylesheet" href="./../.././assets/styles/custom-classes.css" />

</head>

<body class="site">
  <header class="site-header">
    <!-- This logo is a link only on the watching server, not the production build -->
    <a href="">
      <img style="height: 2.5vw;" class="watermark-logo" src="./../../assets/img/0-Shared/logo/pba-logo-white.svg"
        alt="PBA Logo">
    </a>
  </header>
  <main class="reveal">
    <article class="slides">
      <section ><section data-markdown><script type="text/template">

# Consensus: Authoring
</script></section><section data-markdown><script type="text/template">
### Consensus is...

...a decision making process that strives to achieve acceptance of a decision by all participants.
</script></section><section data-markdown><script type="text/template">
## Blockchain Consensus is...

...a decentralized consensus system to reach agreement over a shared history of a state machine.
</script></section><section data-markdown><script type="text/template">
## Blockspace

![Blockspace machine](./img/blockspace-machine.svg)

Blockchain consensus systems produce a resource called blockspace.

Strong incentive alignments and strong guarantees make for high quality blockspace.

<aside class="notes"><p>As we discussed blockspace represents the right to contribute to the shared history. This is a valuable resource that is offered to users as a product. We will discuss the selling of this resource in a later lecture on allocation and fees. The consensus system used plays a large role in determining the quality of the blockspace.</p>
</aside></script></section></section><section  data-markdown><script type="text/template">
## Forks Review

<img style="width: 500px" src="./img/forks-some-invalid.svg" />

There are going to be forks. We need to decide which one is the real one.

We can rule some forks out to reduce the problem space. Then we are left to decide which is canonical.

<aside class="notes"><p>Forks represent alternate courses that history could take. They arise every time there is a difference of opinion.</p>
<p>You can think of them at a social level. Court cases, arguments, wars. Ideally we can resolve them peacefully</p>
<p>You can think of them at a very low physics-y level. Every time an electron encounters a potential barrier it either reflects of tunnels. When consensus is high-quality, the result is as objective as the outcome of a physical process.</p>
</aside></script></section><section ><section data-markdown><script type="text/template">
## Five Aspects of Consensus

<pba-flex center>

- State machine validity
- Arbitrary / Political validity
- Authorship throttling
- Fork choice heuristic
- Finality

</pba-flex>

<aside class="notes"><p>The first two aspects are relatively simple and I&#39;ll discuss them briefly right now. The third and fourth are the main topic of this lecture. The fifth is covered in detail two lectures from now in great detail.</p>
<p>The first three aspects are about ruling possibilities out. The fourth and fifth are about deciding between any remaining possibilities.</p>
</aside></script></section><section data-markdown><script type="text/template">
## State Machine Validity

Some forks can be ruled out simply because they contain invalid state transitions.

![Invalid state transition](./img/invalid-state-transition.svg)

<aside class="notes"><p>Example spending more money than you have. Noting your present location such that you would have traveled faster than speed of light since last record. Calling a smart contract with invalid parameters.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Arbitrary / Political Validity

Similar to state machine validity.<br/>
Examples:

<pba-flex>

- Blocks that are too big
- Blocks that have "hack" transactions
- Empty blocks
- Block with Even state roots

</pba-flex>

![Invalid state transition](./img/politically-invalid-state-transition.svg)

<aside class="notes"><p>This concept is similar to the previous slide. In some sense this is even the same. This allows us to rule out some forks just for not having properties that we like. Or for having properties that we dislike.</p>
<p>Not everyone will agree on these properties ad that leads to long-term network splits.</p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
## Authorship Throttling

Real-world blockchains impose additional restrictions on who can author blocks. Why?

![Unthrottled authoring leads to fork chaos](./img/fork-chaos.svg)

<aside class="notes"><p>These blockchains are supposed to be permissionless right? At least many of them are. Some are even very hardcore about that goal. So why would we want to restrict the authoring.
Answer: So the nodes are not overwhelmed. Unthrottled authoring leads to fork chaos. If anyone authored at any moment there would be blocks raining down left and right. It would be impossible to check them all. It would be DOS central. So we need some organization / order to the process.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Leader Election

We need to elect a small set (or ideally a single) entity who are allowed to author next.

In pre-blockchain consensus this was called the "leader", and still often is.

<aside class="notes"><p>By electing a few leaders, we are able to throttle the authoring.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Liveness

The ability of the system to keep authoring new blocks

<aside class="notes"><p>Before we go on, I want to introduce the concept of liveness. It is a desireable property that consensus systems want to have. Systems that have better liveness properties offer higher quality blockspace. Chains without liveness guarantees become stalled.</p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
## Proof of Work

Satoshi's Big invention.

Solve a Pre-image search - earn the right to author.
</script></section><section data-markdown><script type="text/template">
## Proof of Work: Pros

<pba-flex center>

- Permissionless (or so we thought)
- Requires an external scarce resource: Energy
- Blind: Nobody knows the next author until the moment they publish their block
- Expensive to author competing forks - Clear incentive

</pba-flex>

<aside class="notes"><p>On the surface one big strength of PoW is that anyone can spin up a node and join at any time without anyone&#39;s permission. This is clearly how it was described in the whitepaper. In practice, many systems now have such a high hashrate that your home computer is useless. It is now permissioned by who can afford and acquire the right hardware.</p>
<p>The reliance on an external resource is good in some sense because it is an objective measure of the market&#39;s valuation of the consensus system. This helps valuate the blockspace.</p>
<p>The blindness is a good property because it makes it impossible to perform a targeted attack (DOS or physical) on the next leader to stall the network.</p>
<p>Some attacks rely on the leader authoring two competing forks and gossiping them to different parts of the network. With PoW, it costs energy for every block you author. This makes it expensive to perform such attacks. This provides an economic incentive for authors to only author blocks on the &quot;correct&quot; fork.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Proof of Work: Cons

<pba-flex center>

- Energy Intensive
- Irregular block time
- Not so permissionless

</pba-flex>

<aside class="notes"><p>Energy consumption is more often considered a negative property. Sometimes called proof of <em>waste</em>. I won&#39;t go that far, but in a world where climate change is a reality, it is certainly not ideal to be spending so much energy if we can get away with far less.</p>
<p>Worth noting that some PoW schemes (eg Monero&#39;s) strive to minimize the energy impact by choosing algorithms that are &quot;asic resistant&quot;. While these are decidedly better than Bitcoin&#39;s, they do not fundamentally solve the problem. Just alleviate it somewhat in practice.</p>
<p>Secondly, the block time is only probabilistically known. When waiting for block to be authored, there are sometimes spurts of blocks followed by long stretches without any.</p>
<p>Although it seems permissionless on its face, in practice, to be a bitcoin miner you need to have expensive specialized hardware.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Why Author at All?

- Altruism - You feel good about making the world a better place
- Your Transitions - Because you want to get your own transitions in
- Explicit incentives - Eg block reward

<aside class="notes"><p>If it costs energy to author blocks, why would anyone want to author to begin with?</p>
<p>Mining only when you want to get your transaction in seems like a good idea to me. People who don&#39;t want to self author, can pay other a fee to do it for them. This is the purpose of transaction fees. Most chains have transaction fees specified in the transactions themselves which go to the author</p>
<p>Some networks also add an explicit incentives such as a 50BTC reward per block.</p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
## Proof of Authority

Traditional class of solutions.

Divide time into slots.

Certain identities are allowed to author in each slot.

Prove your identity with a signature.
</script></section><section data-markdown><script type="text/template">
## Proof of Authority: Pros

<pba-flex center>

- Low energy consumption
- Stable block time

</pba-flex>

<aside class="notes"><p>Stable block time is a property of high-quality block space. It allows applications that consume the blockspace to have expectations about throughput. In PoW you will occasionally have long periods without a block which can negatively affect applications.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Proof of Authority: Cons

<pba-flex center>

- Permissioned
- No external resource to aid valuation
- Incentives for honesty are not always clear

</pba-flex>

<aside class="notes"><p>Does anything bad happen if they misbehave? Not inherently. We will need an incentive for that.</p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
# Some PoA Schemes

Reminder: PoA is a family of leader election schemes
</script></section><section data-markdown><script type="text/template">
## Aura

The simple one.

Everyone takes turns in order.

```rust
authority(slot) = authorities[slot % authorities.len()];
```

<aside class="notes"><p>Pros:</p>
<ul>
<li>Simple</li>
<li>Single leader elected in each slot</li>
</ul>
<p>Cons:</p>
<ul>
<li>Not blind - welcome targeted attacks</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
## Babe

**B**lind **A**ssignment for **B**lockchain **E**xtension

- In each slot, compute a VRF output.
- If it is below a threshold, you are eligible to author.
<!-- .element: class="fragment" data-fragment-index="2" -->
- If eligible, author a block showing VRF proof
<!-- .element: class="fragment" data-fragment-index="3" -->
- If NOT eligible, do nothing
<!-- .element: class="fragment" data-fragment-index="4" -->

<aside class="notes"><p>Pros:</p>
<ul>
<li>No fixed order helps alleviate DOS attacks</li>
</ul>
<p>Cons:</p>
<ul>
<li>Some slots have no authors - There is a workaround for this</li>
<li>Other slots have multiple authors which leads to forks. There is no workaround for this</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
## Sassafras

<pba-cols>
<pba-col>
<img style="width: 500px" src="./img/Sassafras-albidum.jpg" />
</pba-col>
<pba-col>

Single blind VRF-based leader election

ðŸ™ˆTBH, IDK how it works internally. <!-- .element: class="fragment" data-fragment-index="2" -->

But Jeff does! <!-- .element: class="fragment" data-fragment-index="3" -->

</pba-col>
</pba-cols>

<aside class="notes"><ul>
<li>Has most of the Pros of PoW (except for the external resource based valuation hint)</li>
<li>Has all the Pros of PoA</li>
</ul>
<!-- TODO style: fix rounded img css issue here --></aside></script></section><section data-markdown><script type="text/template">
## Sassafras Analogy

<pba-cols>
<pba-col>
<img src="./img/jeff.jpeg" />
</pba-col>
<pba-col>

> Sassafras is kinda cards against humanity

</pba-col>
</pba-cols></script></section><section data-markdown><script type="text/template">
## Sassafras Analogy

<img width="400px" style="float: left; padding: 1px;" src="./img/caa_black.png" />
<img width="400px" style="float: left; padding: 1px;" src="./img/caa_white_1.png" />
<!-- .element: class="fragment" data-fragment-index="2" -->
<img width="400px" style="float: left; padding: 1px;" src="./img/caa_white_2.png" />
<!-- .element: class="fragment" data-fragment-index="3" -->
</script></section><section data-markdown><script type="text/template">
## Sassafras Analogy

<pba-cols>
<pba-col>
<img src="./img/jeff.jpeg" />
</pba-col>
<pba-col>
<blockquote style="font-size: 80%">Ring VRF outputs are "cards".  You anonymously "play" the best aka smallest cards in your hand.</blockquote>
<!-- .element: class="fragment" data-fragment-index="2" -->
<blockquote style="font-size: 80%">Those cards are sorted, not by funniness since they're just numbers, but by the number.</blockquote>
<!-- .element: class="fragment" data-fragment-index="3" -->
<blockquote style="font-size: 80%">The order in which they wind up is the block production order.</blockquote>
<!-- .element: class="fragment" data-fragment-index="4" -->
<blockquote style="font-size: 80%">You claim the ones that're yours by doing a non-ring VRF with identical outputs.</blockquote>
<!-- .element: class="fragment" data-fragment-index="5" -->
</pba-col>
</pba-cols>
</script></section><section data-markdown><script type="text/template">
# Proof of Stake

It's just PoA in disguise ðŸ¤¯

Uses an economic staking game to select the authorities.

Restores the permissionlessness to at least PoW levels.

Restores clear economic incentives

<aside class="notes"><p>There is an economic game called staking as part of the state machine that allows selecting the authorities who will participate in the PoA scheme. Actually there isn&#39;t just <em>one</em> way to do it, there are many. Kian will talk a lot more about this and about the way it is done in Polkadot later. I&#39;ll just give the flavor now.</p>
<p>The basic idea is that anyone can lock up some tokens on chain (in the state machine). The participants with the most tokens staked are elected as the authorities. There is a state transition that allows reporting authority misbehavior (eg authoring competing blocks at the same height), and the authority loses their tokens. There are often block rewards too like PoW.</p>
</aside></script></section><section data-markdown><script type="text/template">
## ðŸ’’ Consensus ðŸª¢ State Machine

- Loose coupling between consensus and state machine is common
- Eg Block rewards, slashing, authority election
- In PoW there is a difficulty adjustment algorithm

In Substrate there is a concept of a **Runtime API** - Consensus can read information from state machine.

<!-- .element: class="fragment" data-fragment-index="2" -->

<aside class="notes"><p>So far I&#39;ve presented consensus as orthogonal to the state machine. This is mostly true. But in practice it is extremely common for there to be some loose coupling. We already saw an example when we talked about block rewards. The consensus authors are rewarded with tokens (in the state machine) for authoring blocks. Now we see that they can have tokens slashed (in state machine) for breaking consensus protocol. And we see that even the very authorities can be elected in the state machine.</p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
# Fork Choice Heuristics

Each node's preference for which fork is best

<pba-flex center>

- Longest chain rule
- Most accumulated work
- Most blocks authored by Alice
- Most total transactions (or most gas)

<img style="width: 500px" src="./img/reorgs-1.svg" />

</pba-flex>

<aside class="notes"><p>The fork choice allows you, as a network participant, to decide which fork you consider best for now. It is not binding. Your opinion can change as you see more blocks appear on the network</p>
</aside></script></section><section data-markdown><script type="text/template">
## Reorganizations

<img style="width: 500px" src="./img/reorgs-1.svg" />

<img style="width: 500px" src="./img/reorgs-2.svg" /> <!-- .element: class="fragment" data-fragment-index="2" -->

Dropped transactions re-enter tx pool and re-appear in new blocks shortly <!-- .element: class="fragment" data-fragment-index="3" -->

<aside class="notes"><p>Having seen more blocks appear, we now have a different opinion about what chain is best. This is known as a reorg. Re-orgs are nearly inevitable. There area ways to make sure they don&#39;t happen at all, but there are significant costs to preventing them entirely. Typically short reorgs are not a big problem, but deep reorgs are.</p>
<p>You can experience this in a social way too.</p>
<ul>
<li>Imagine that you are waiting for a colleague to submit a paper. You believe they have submitted it yesterday, but it turns out that they didn&#39;t submit it until today or won&#39;t submit it until tomorrow. Might be annoying, but not world shattering (usually)</li>
<li>Imagine that you believe the colleague submitted the paper months ago and the paper has been published. You have applied on a job having listed the publication</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
## Double Spends

<img style="width: 800px" src="./img/double-spend-1.svg" />

<aside class="notes"><p>The name comes from bitcoin, but the attack generalizes. It exploits the existence of forks. Attacker has to get two conflicting transactions into two forks. And convince a counterparty to believe one chain long enough to take an off-chain action before they see the reorg.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Double Spends

<img style="width: 800px" src="./img/double-spend-2.svg" />
</script></section></section><section  data-markdown><script type="text/template">
## Five Aspects of Consensus

<pba-flex center>

- State machine validity
- Arbitrary / Political validity
- Authorship throttling
- Fork choice heuristic
- Finality

</pba-flex>

<aside class="notes"><p>We just discussed the first four aspects. Finality will be discussed in an upcoming lesson</p>
</aside></script></section>
    </article>
  </main>

  <script src="./../../dist/reveal.js"></script>

  <script src="./../../plugin/markdown/markdown.js"></script>
  <script src="./../../plugin/highlight/highlight.js"></script>
  <script src="./../../plugin/zoom/zoom.js"></script>
  <script src="./../../plugin/notes/notes.js"></script>
  <script src="./../../plugin/math/math.js"></script>

  <script src="./../../assets/plugin/mermaid.js"></script>
  <script src="./../../assets/plugin/mermaid-theme.js"></script>

  <script src="./../../assets/plugin/chart/chart.js"></script>
  <script src="./../../assets/plugin/chart/chart.min.js"></script>

  <script src="./../../assets/plugin/tailwindcss.min.js"></script>

  <script>
    function extend() {
      var target = {};
      for (var i = 0; i < arguments.length; i++) {
        var source = arguments[i];
        for (var key in source) {
          if (source.hasOwnProperty(key)) {
            target[key] = source[key];
          }
        }
      }
      return target;
    }

    // default options to init reveal.js
    var defaultOptions = {
      controls: true,
      progress: true,
      history: true,
      center: true,
      transition: 'default', // none/fade/slide/convex/concave/zoom
      slideNumber: true,
      mermaid: {
        startOnLoad: false,
        logLevel: 3,
        theme: 'base',
        themeVariables: {
          primaryColor: purple,
          primaryTextColor: white,
          primaryBorderColor: pink,
          lineColor: pink,
          secondaryColor: lightPurple,
          tertiaryColor: lightPurple,
        },
      },
      chart: {
        defaults: {
          color: 'lightgray', // color of labels
          scale: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
            grid: { color: "lightgray" }, // color of grid lines
          },
        },
        line: { borderColor: ["#ccc", "#E6007A", "#6D3AEE"], "borderDash": [[5, 10], [0, 0]] },
        bar: { backgroundColor: ["#ccc", "#E6007A", "#6D3AEE"] },
      },
      plugins: [
        RevealMarkdown,
        RevealHighlight,
        RevealZoom,
        RevealNotes,
        RevealMath,
        RevealMermaid,
        RevealChart
      ]
    };

    // options from URL query string
    var queryOptions = Reveal().getQueryHash() || {};

    var options = extend(defaultOptions, {"width":1400,"height":900,"margin":0,"minScale":0.2,"maxScale":2,"transition":"none","controls":true,"progress":true,"center":true,"slideNumber":true,"backgroundTransition":"fade"}, queryOptions);
  </script>


  <script>
    Reveal.initialize(options);
  </script>
</body>

</html>