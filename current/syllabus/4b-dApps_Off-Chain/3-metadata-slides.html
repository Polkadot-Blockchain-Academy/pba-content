<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Metadata</title>
  <link rel="icon" href="./../../assets/favicon.svg" />
  <link rel="shortcut icon" href="./../../assets/favicon.png" />
  <link rel="stylesheet" href="./../../dist/reset.css" />
  <link rel="stylesheet" href="./../../dist/reveal.css" />
  <link rel="stylesheet" href="./../.././assets/styles/PBA-theme.css" id="theme" />
  <link rel="stylesheet" href="./../../css/highlight/shades-of-purple.css" />

  <link rel="stylesheet" href="./../.././assets/styles/custom-classes.css" />

</head>

<body class="site">
  <header class="site-header">
    <!-- This logo is a link only on the watching server, not the production build -->
    <a href="">
      <img style="height: 2.5vw;" class="watermark-logo" src="./../../assets/img/0-Shared/logo/pba-logo-white.svg"
        alt="PBA Logo">
    </a>
  </header>
  <main class="reveal">
    <article class="slides">
      <section  data-markdown><script type="text/template">

# Metadata
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Content

- Mod. 2 recap:
  - What is the runtime (and its metadata)?
  - The metadata sets us apart of other blockchains.
- Deep dive into metadata
- Extrinsics
</script></section><section  data-markdown><script type="text/template">
## Runtime

- The runtime is the business logic of Polkadot-based networks.
- It defines the algorithm needed for determining the state of the next block.
- It is part of the state, not part of the host.

<aside class="notes"><p>Compared to other blockchains (such as Ethereum) the logic to determine the next block state is not part of the
state itself. Therefore, it can&#39;t be modified without a change in the host itself.</p>
</aside></script></section><section  data-markdown><script type="text/template">
## Metadata

- The Runtime's Metadata is a bunch of information needed to interact with the Runtime. It defines the shape of the
  interactions, instead of "what" do they do.
- It includes _enough_ information to perform any kind of interaction with the blockchain, as well as decoding its state.
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Shape

The metadata is versioned, and its current stable version is `15`.

```typescript
interface RuntimeMetadataV15 {
  types: Vec<LookupEntry>;
  pallets: Vec<PalletMetadata>;
  extrinsic: ExtrinsicMetadata;
  ty: Type; // not useful, it is the type of the runtime itself
  apis: Vec<RuntimeApiMetadata>;
  outer_enums: OuterEnums;
  custom: CustomMetadata; // we won't enter this one, un-typed extra metadata
}
```
</script></section><section ><section data-markdown><script type="text/template">
## Metadata

#### Lookup

The lookup of the metadata defines the shape of all types used in the runtime.

<span style="font-size: 0.6em; opacity: 0.6">(This is already `scale-info`)</span>

```typescript [|2|3,4,6|5]
interface LookupEntry {
  id: u32; // this one is unique, and sequential
  path: Vec<String>; // where is it found in Rust code
  type_params: Vec<TypeParameter>; // Rust generics
  type_def: TypeDef; // THE JUICE!
  docs: Vec<String>; // Rust docs
}
```

<aside class="notes"><p>Docs are self-descriptive. Type params only give information about the generics used in Rust. Path defines the file
where it is defined in rust.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Metadata

#### Lookup `type_def`

```typescript
enum TypeDef {
  Composite, // struct
  Variant, // enum
  Sequence, // variable length
  Array, // fixed length
  Tuple,
  Primitive, // essentially integers and booleans
  Compact,
  BitSequence,
}
```

<aside class="notes"><p>Explain a bit every one. Don&#39;t focus particularly, it is just a quick summary of something already explained in mod 2.</p>
</aside></script></section><section data-markdown><script type="text/template">
## Metadata

#### Lookup challenges

- Circular types
  - There are types that reference themselves, or form circles.
  - This makes it difficult to calculate a _checksum_ of the type itself.

<span style="font-size: 0.6em; opacity: 0.6">We used Tarjan's SCC algorithm to detect cycles, see notes</span>

![Image](./img/circular-lookup.svg)

<aside class="notes"><p><a href="https://en.wikipedia.org/wiki/Tarjan&#39;s_strongly_connected_components_algorithm">https://en.wikipedia.org/wiki/Tarjan&#39;s_strongly_connected_components_algorithm</a></p>
</aside></script></section><section data-markdown><script type="text/template">
## Metadata

#### Lookup challenges

- Mirrored types
  - These are types that are completely equivalent, but yet they have different structures that connect them.

<img src="./img/mirrored-lookup.svg" width="50%" />
</script></section><section data-markdown><script type="text/template">
## Metadata

#### Lookup challenges

- _Second-class_ citizens
  - Types like balances (_"amount"_) or `AccountId32` are first-class citizens in the blockchains, yet in the Metadata they are not. Identifying them as what they are is a heuristic labour.
</script></section><section data-markdown><script type="text/template">
#### Example: `AccountId32` and _Balance_

```json [|2-17|18-27]
[
  {
    "id": 0,
    "path": ["sp_core", "crypto", "AccountId32"],
    "params": [],
    "def": {
      "tag": "composite",
      "value": [
        {
          "type": 1,
          "typeName": "[u8; 32]",
          "docs": []
        }
      ]
    },
    "docs": []
  },
  {
    "id": 63,
    "path": [],
    "params": [],
    "def": {
      "tag": "compact",
      "value": 6 // u128
    },
    "docs": []
  }
]
```
</script></section><section data-markdown><script type="text/template">
## Metadata

#### Lookup challenges

- Non-descriptive types
  - Some types are created in Rust in a way that they get generated in a non-descriptive way.
  - There are some that are on purpose created this way to save bytes when encoded.
</script></section><section data-markdown><script type="text/template">
#### Example: `IdentityData`

- A variable length array of bytes `Vec<u8>` (up to `len=32`) is expressed as several variants in an enum.

```json
{
  "id": 327,
  "path": ["pallet_identity", "types", "Data"],
  "params": [],
  "def": {
    "tag": "variant",
    "value": [
      {
        "name": "None",
        "fields": [],
        "index": 0,
        "docs": []
      },
      {
        "name": "Raw0",
        "fields": [
          {
            "type": 328,
            "docs": []
          }
        ],
        "index": 1,
        "docs": []
      },
      {
        "name": "Raw1",
        "fields": [
          {
            "type": 329,
            "docs": []
          }
        ],
        "index": 2,
        "docs": []
      },
      {
        "name": "Raw2",
        "fields": [
          {
            "type": 330,
            "docs": []
          }
        ],
        "index": 3,
        "docs": []
      },
      {â€¦},
      {
        "name": "Raw32",
        "fields": [
          {
            "type": 1,
            "docs": []
          }
        ],
        "index": 33,
        "docs": []
      },
      {
        "name": "BlakeTwo256",
        "fields": [
          {
            "type": 1,
            "docs": []
          }
        ],
        "index": 34,
        "docs": []
      },
      {â€¦}
    ]
  },
  "docs": []
}
```
</script></section><section data-markdown><script type="text/template">
#### Example: `Vote`

- It encodes `{ aye: boolean; conviction: [0..6] }`
- `aye` fits in one bit, and `conviction` fits in the rest of the `u8` (aka `u7`).
- `vote = (aye << 7) + conviction`

```json
{
  "id": 155,
  "path": ["pallet_conviction_voting", "vote", "Vote"],
  "params": [],
  "def": {
    "tag": "composite",
    "value": [
      {
        "type": 2, // u8
        "docs": []
      }
    ]
  },
  "docs": []
}
```
</script></section><section data-markdown><script type="text/template">
## Metadata

#### Metadata is autogenerated!

- Many of these flaws arise due to the way the metadata is generated from the Rust code directly.
- Some of the Runtime implementation details leak to the metadata
</script></section></section><section  data-markdown><script type="text/template">
## Metadata

#### Outer Enums

They are sugar! One can build this type by himself by aggregating all pallets information.

These types are handy though to decode any `call_data`, `event`, or module `error`.

```typescript
interface OuterEnums {
  // lookup indices
  call_enum_ty: Type;
  event_enum_ty: Type;
  error_enum_ty: Type;
}
```
</script></section><section ><section data-markdown><script type="text/template">
## Metadata

#### Runtime APIs

They allow to execute functions from the Runtime itself.
Examples:

- Dry Run
- Fee estimation
- Metadata

```typescript
interface RuntimeApiMetadata {
  name: String;
  methods: Vec<{
    name: String;
    inputs: Vec<{ name: String; ty: Type }>; // lookup index
    output: Type; // as well!
    docs: Vec<String>;
  }>;
  docs: Vec<String>;
}
```

<aside class="notes"><p>Use this slide to exemplify the &quot;pointer&quot; idea of the metadata.</p>
</aside></script></section><section data-markdown><script type="text/template">
Example: `Metadata` APIs

```json [|4-9|26-31|10-25]
{
  "name": "Metadata",
  "methods": [
    {
      "name": "metadata",
      "inputs": [],
      "output": 862,
      "docs": [" Returns the metadata of a runtime."]
    },
    {
      "name": "metadata_at_version",
      "inputs": [
        {
          "name": "version",
          "type": 4
        }
      ],
      "output": 863,
      "docs": [
        " Returns the metadata at a given version.",
        "",
        " If the given `version` isn't supported, this will return `None`.",
        " Use [`Self::metadata_versions`] to find out about supported metadata version of the runtime."
      ]
    },
    {
      "name": "metadata_versions",
      "inputs": [],
      "output": 121,
      "docs": [" Returns the supported metadata versions.", "", " This can be used to call `metadata_at_version`."]
    }
  ],
  "docs": [" The `Metadata` api trait that returns metadata for the runtime."]
}
```
</script></section></section><section  data-markdown><script type="text/template">
## Metadata

#### Pallets

Every pallet can define an arbitrary number (including none) of **constants**, **calls**, **events**, **errors**,
**storage queries**. We will walk every one of them.

```typescript
interface PalletMetadata {
  name: String;
  constants: Vec<PalletConstantMetadata>;
  event: Option<Type>;
  error: Option<Type>;
  calls: Option<Type>;
  storage: Option<PalletStorageMetadata>;
  index: u8;
  docs: Vec<String>; // rust docs
}
```
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Constants

They represent values that are defined in compile time of the runtime.
The metadata includes both the type of them and their values.

```typescript
interface PalletConstantMetadata {
  name: String;
  ty: Type;
  value: Vec<u8>;
  docs: Vec<String>;
}
```
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Events

They are emitted by the runtime when executing certain actions.

There are three types (called `phase`s):

- Initialization: runtime _hooks_ before applying transactions
- Apply Extrinsic: events emitted by applying transactions
- Finalization: runtime _hooks_ after applying transactions

They can also include topics, which generally are a vector of hashes. They can be useful to help identify the origin of
the event (e.g. smart contracts).
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Errors

Pallets can define errors to explain why an extrinsic had no success.

- `System.ExtrinsicSuccess` ðŸŽ‰
- `System.ExtrinsicFailed` ðŸ”´
  - Inside its payoad we find the specific error.
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Calls

They expose all transactions available in that pallet.

We will dig into it during the day.
</script></section><section  data-markdown><script type="text/template">
## Metadata

Example: `System`

```json
{
  "name": "System",
  "storage": {â€¦}, // let's follow up with it!
  "calls": 94,
  "events": 22,
  "constants": [
    {
      "name": "Version",
      "type": 508,
      "value": "0x20706f6c6b61646f743c7061726974792d706f6c6b61646f7400000000fc4d0f00000000005cc51ff1fa3f5d0cca01000000df6acb689907609b0500000037e397fc7c91f5e40200000040fe3ad401f8959a0600000017a6bc0d0062aeb30100000018ef58a3b67ba77001000000d2bc9897eed08f1503000000f78b278be53f454c02000000af2c0297a23e6d3d0b00000049eaaf1b548a0cb00300000091d5df18b0d2cf58020000002a5e924655399e6001000000ed99c5acb25eedf503000000cbca25e39f14238702000000687ad44ad37f03c201000000ab3c0572291feb8b01000000bc9d89904f5b923f0100000037c8bb1350a9a2a804000000f3ff14d5ab527059030000006ff52ee858e6c5bd0100000091b1c8b16328eb92010000009ffb505aa738d69c01000000fbc577b9d747efd6010000001a00000001",
      "docs": [" Get the chain's in-code version."]
    },
    {â€¦}
  ],
  "errors": 512,
  "index": 0,
  "docs": []
}
```
</script></section><section  data-markdown><script type="text/template">
## Metadata

#### Storage

Every pallet can **optionally** define storage entries. They have the following shape in the metadata:

```typescript [|2|3-13|4|5,14|6-13]
interface PalletStorageMetadata {
  prefix: String;
  entries: Vec<{
    name: String;
    modifier: "Optional" | "Default";
    ty: Enum<{
      Plain: { value: Type };
      Map: {
        hashers: Vec<StorageHasher>;
        key: Type;
        value: Type;
      };
    }>;
    default: Vec<u8>;
    docs: Vec<String>;
  }>;
}
```
</script></section><section  data-markdown><script type="text/template">
## Metadata

Example: `System`

```json
{
  "name": "System",
  "storage": {
    "prefix": "System",
    "items": [
      {
        "name": "Account",
        "modifier": 1,
        "type": {
          "tag": "map",
          "value": {
            "hashers": [
              {
                "tag": "Blake2128Concat"
              }
            ],
            "key": 0,
            "value": 3
          }
        },
        "fallback": "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080",
        "docs": [" The full account information for a particular account ID."]
      },
      {
        "name": "ExtrinsicCount",
        "modifier": 0,
        "type": {
          "tag": "plain",
          "value": 4
        },
        "fallback": "0x00",
        "docs": [" Total extrinsics count for the current block."]
      },
      {â€¦}
    ]
  },
  {â€¦}
}
```
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Content

- What is an extrinsic?
- Extrinsic v4 deep dive
- Future: extrinsic v5
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

An **extrinsic** is a request to the runtime to modify the state from outside of it.

TL;DR: **extrinsic** == **transaction**
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Type and Versioning

Every extrinsic starts with a version byte, inclunding the extrinsic kind and version.

| Version |   Kind   |    Version Byte     |
| :-----: | :------: | :-----------------: |
|    4    | Unsigned |  4 (`0b0000_0100`)  |
|    4    |  Signed  | 132 (`0b1000_0100`) |
|    5    |   Bare   |  5 (`0b0000_0101`)  |
|    5    | General  | 69 (`0b0100_0101`)  |

<span style="font-size: 0.6em; opacity: 0.6">We will focus on version 4, and explain version 5 a bit ahead</span>
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Metadata

```typescript
interface ExtrinsicMetadata {
  version: 4;
  address_ty: Type;
  call_ty: Type;
  signature_ty: Type;
  extra_ty: Type;
  signed_extensions: Vec<{
    identifier: String;
    ty: Type;
    additional_signed: Type;
  }>;
}
```
</script></section><section ><section data-markdown><script type="text/template">
## Extrinsic

#### Signed extensions

Signed extensions are appended to every signed extrinsic with information that is agnostic to the call itself. Examples:

- Mortality (i.e. until which block the transaction should be valid)
- Tip
- Genesis hash
- Nonce
</script></section><section data-markdown><script type="text/template">
#### `additional_signed`

Some of them are _implicit_. They can only be one single value to be valid. Therefore, they are not encoded in the
extrinsic to save block space, yet they are signed. Examples:

- Spec version
- Genesis hash
</script></section><section data-markdown><script type="text/template">
#### `extra`

These are parts that need to be _explicit_, since multiple values might be valid. They are encoded in the extrinsic.
Examples:

- Tip
- Nonceâ„¢
- Mortality
</script></section></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Extrinsic shape

![Image](./img/extrinsic.svg)

<span style="font-size: 0.6em; opacity: 0.6">It is _opaque_ encoded; i.e. prepended by its compact-encoded length</span>
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Sign Payload

In order to sign an extrinsic, the payload to be signed by the algorithm is:

![Image](./img/sign-payload.svg)
</script></section><section  data-markdown><script type="text/template">
## Extrinsic

#### Future: `v5`

Extrinsic `v5` will rely on extensions to define its origin. I.e. no `origin` or `signature` will be hardcoded.

This increases the flexibility of the extrinsics, leaving the runtime (through extensions) decide the permission level.

![Image](./img/extrinsic-v5.svg)

<span style="font-size: 0.6em; opacity: 0.6">Take it with a pinch of salt, it is still under RFC process (RFC#0124)</span>
</script></section>
    </article>
  </main>

  <script src="./../../dist/reveal.js"></script>

  <script src="./../../plugin/markdown/markdown.js"></script>
  <script src="./../../plugin/highlight/highlight.js"></script>
  <script src="./../../plugin/zoom/zoom.js"></script>
  <script src="./../../plugin/notes/notes.js"></script>
  <script src="./../../plugin/math/math.js"></script>

  <script src="./../../assets/plugin/mermaid.js"></script>
  <script src="./../../assets/plugin/mermaid-theme.js"></script>

  <script src="./../../assets/plugin/chart/chart.js"></script>
  <script src="./../../assets/plugin/chart/chart.min.js"></script>

  <script src="./../../assets/plugin/tailwindcss.min.js"></script>

  <script>
    function extend() {
      var target = {};
      for (var i = 0; i < arguments.length; i++) {
        var source = arguments[i];
        for (var key in source) {
          if (source.hasOwnProperty(key)) {
            target[key] = source[key];
          }
        }
      }
      return target;
    }

    // default options to init reveal.js
    var defaultOptions = {
      controls: true,
      progress: true,
      history: true,
      center: true,
      transition: 'default', // none/fade/slide/convex/concave/zoom
      slideNumber: true,
      mermaid: {
        startOnLoad: false,
        logLevel: 3,
        theme: 'base',
        themeVariables: {
          primaryColor: purple,
          primaryTextColor: white,
          primaryBorderColor: pink,
          lineColor: pink,
          secondaryColor: lightPurple,
          tertiaryColor: lightPurple,
        },
      },
      chart: {
        defaults: {
          color: 'lightgray', // color of labels
          scale: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
            grid: { color: "lightgray" }, // color of grid lines
          },
        },
        line: { borderColor: ["#ccc", "#E6007A", "#6D3AEE"], "borderDash": [[5, 10], [0, 0]] },
        bar: { backgroundColor: ["#ccc", "#E6007A", "#6D3AEE"] },
      },
      plugins: [
        RevealMarkdown,
        RevealHighlight,
        RevealZoom,
        RevealNotes,
        RevealMath,
        RevealMermaid,
        RevealChart
      ]
    };

    // options from URL query string
    var queryOptions = Reveal().getQueryHash() || {};

    var options = extend(defaultOptions, {"width":1400,"height":900,"margin":0,"minScale":0.2,"maxScale":2,"transition":"none","controls":true,"progress":true,"center":true,"slideNumber":true,"backgroundTransition":"fade"}, queryOptions);
  </script>


  <script>
    Reveal.initialize(options);
  </script>
</body>

</html>
