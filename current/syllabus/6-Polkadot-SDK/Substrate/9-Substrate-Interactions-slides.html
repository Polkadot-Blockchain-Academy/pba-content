<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Interacting With a Substrate Blockchain</title>
  <link rel="icon" href="./../../../assets/favicon.svg" />
  <link rel="shortcut icon" href="./../../../assets/favicon.png" />
  <link rel="stylesheet" href="./../../../dist/reset.css" />
  <link rel="stylesheet" href="./../../../dist/reveal.css" />
  <link rel="stylesheet" href="./../../.././assets/styles/PBA-theme.css" id="theme" />
  <link rel="stylesheet" href="./../../../css/highlight/shades-of-purple.css" />

  <link rel="stylesheet" href="./../../.././assets/styles/custom-classes.css" />

</head>

<body class="site">
  <header class="site-header">
    <!-- This logo is a link only on the watching server, not the production build -->
    <a href="">
      <img style="height: 2.5vw;" class="watermark-logo" src="./../../../assets/img/0-Shared/logo/pba-logo-white.svg"
        alt="PBA Logo">
    </a>
  </header>
  <main class="reveal">
    <article class="slides">
      <section  data-markdown><script type="text/template">

# Interacting With a Substrate Blockchain
</script></section><section  data-markdown><script type="text/template">
## Before we start

- Find all the commands that will be used in this workshop in the `speaker notes`:
- Run these two now:

```
cargo install staging-chain-spec-builder
cargo install --force --git https://github.com/kianenigma/pba-omni-node.git
```

<aside class="notes"><p>Install stuff
cargo install staging-chain-spec-builder
cargo install --force --git <a href="https://github.com/kianenigma/pba-omni-node.git">https://github.com/kianenigma/pba-omni-node.git</a></p>
<p>generate chain-spec file
chain-spec-builder create --chain-name pba-chain -r ./target/release/wbuild/minimal-template-runtime/minimal_template_runtime.wasm default</p>
<p>add some stuff to <code>balances.balances</code></p>
<p>[&quot;5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY&quot;, 1000000],
[&quot;5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty&quot;, 1000000],
[&quot;5FLSigC9HGRKVhB9FiEo4Y3koPsNmBmLJbpXg2mp1hXcS59Y&quot;, 1000000],
[&quot;5DAAnrj7VHTznn2AWBemMuyBwZWs6FNFjdyVXUeYum3PTXFy&quot;, 1000000],
[&quot;5HGjWAeFDfFCWPsjFQdVV2Msvz2XtMktvgocEZcCj68kUMaw&quot;, 1000000],
[&quot;5CiPPseXPECbkjWCa6MnjNokrgYjMqmKndv2rSnekmSK2DjL&quot;, 1000000],
[&quot;5GNJqTPyNqANBkUVMN1LPPrxXnFouWXoe2wNSmmEoLctxiZY&quot;, 1000000],
[&quot;5HpG9w8EBLe5XCrbczpwq5TSXvedjrBGCwqxK1iQ7qUsSWFc&quot;, 1000000],
[&quot;5Ck5SLSHYac6WFt5UZRSsdJjwmpSZq85fd5TRNAdZQVzEAPT&quot;, 1000000],
[&quot;5HKPmK9GYtE1PSLsS1qiYU9xQ9Si1NcEhdeCq9sw5bqu4ns8&quot;, 1000000],
[&quot;5FCfAonRZgTFrTd9HREEyeJjDpT397KMzizE6T3DvebLFE7n&quot;, 1000000],
[&quot;5CRmqmsiNFExV6VbdmPJViVxrWmkaXXvBrSX8oqBT8R9vmWk&quot;, 1000000],
[&quot;5Fxune7f71ZbpP2FoY3mhYcmM596Erhv1gRue4nsPwkxMR4n&quot;, 1000000],
[&quot;5CUjxa4wVKMj3FqKdqAUf7zcEMr4MYAjXeWmUf44B41neLmJ&quot;, 1000000]</p>
<p>Change chain typw</p>
<p>&quot;chainType&quot;: &quot;Development&quot;</p>
<p>&quot;properties&quot;: {
&quot;tokenDecimals&quot;: 1,
&quot;tokenSymbol&quot;: &quot;PBA&quot;
},</p>
<p>Now you are ready for PJS</p>
</aside></script></section><section ><section data-markdown><script type="text/template">
## Running a Substrate Chain

- The 2024 and beyond edition
- omni-node-driven-future

<aside class="notes"><p><a href="https://forum.polkadot.network/t/polkadot-parachain-omni-node-gathering-ideas-and-feedback/7823/4">https://forum.polkadot.network/t/polkadot-parachain-omni-node-gathering-ideas-and-feedback/7823/4</a></p>
</aside></script></section><section data-markdown><script type="text/template">
## Running a Substrate Chain

- A Substrate node was meant to be oblivious to the runtime
- Truth is that we have cheated a bit for some optimizations over the years
  - Genesis state
  - Native runtime for debugging

...

- Now, we are moving back towards removing the native runtime.
- Node can be fully oblivious to the runtime, except for some _assumptions_:
  - Consensus, Block/Header format, database type

#### ☯️ !!Omni Nodes!! ☯️
</script></section><section data-markdown><script type="text/template">
## Running a Substrate Chain

- A runtime template --> `.wasm` file
  - Exposes some apis that define how the genesis state should be built
- A `chain-spec` file
  - Specification of the chain, most notably includes **genesis state**.
  - Possibly generated with `chain-spec-builder`
- `./omni-node --chain spec.json --tmp...`

<aside class="notes"><p><a href="https://paritytech.github.io/polkadot-sdk/master/sc_chain_spec/index.html">https://paritytech.github.io/polkadot-sdk/master/sc_chain_spec/index.html</a></p>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
## Interacting With a Substrate Blockchain

> How does a user or an application interact with a blockchain?

<aside class="notes"><ul>
<li>Wait for 1 answer from students or at least for 10 seconds.</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
## Interacting With a Substrate Blockchain

- Usually they connect to a public RPC server, i.e. a substrate node that exposes its RPC interface publicly.

<br/>

- Run their own node.

<!-- .element: class="fragment" -->
</script></section><section data-markdown><script type="text/template">
## Interacting With a Substrate Blockchain

<img style="width: 1200px;" src="../../../assets/img/5-Substrate/dev-4-1-json.svg" />
</script></section></section><section ><section data-markdown><script type="text/template">
## JSON-RPC

> JSON-RPC is a remote procedure call protocol encoded in JSON. It is similar to the XML-RPC
> protocol, defining only a few data types and commands.
</script></section><section data-markdown><script type="text/template">
### JSON-RPC

```json
{
  "jsonrpc": "2.0",
  "method": "subtract",
  "params": {
    "minuend": 42,
    "subtrahend": 23
  },
  "id": 3
}
```

<br/>

```json
{
  "jsonrpc": "2.0",
  "result": 19,
  "id": 3
}
```

<!-- .element: class="fragment" -->
</script></section><section data-markdown><script type="text/template">
### JSON-RPC

- Entirely transport agnostic.
- Substrate based chains expose both `websocket` and `http` (or `wss` and `https`, if desired).

<aside class="notes"><ul>
<li>You could choose which port to run the ws or http server on by using the flags <code>--ws-port</code> and <code>--rpc-port</code>
respectively. By default, port 9944 is used.</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
### JSON-RPC

The RPC methods that a substrate node exposes are scoped and has the pattern `"<scope>_<method>"`.

```sh
 wscat \
  -c ws://localhost:9944 \
  -x '{"jsonrpc":"2.0", "id": 42, "method":"rpc_methods" }' \
  | jq
```
</script></section><section data-markdown><script type="text/template">
### JSON-RPC: Scopes

- &shy;<!-- .element: class="fragment" --> `author`: for submitting extrinsic to the chain.
- &shy;<!-- .element: class="fragment" --> `chain`: for retrieving information about the _blockchain_ data.
- &shy;<!-- .element: class="fragment" --> `state`: for retrieving information about the _state_ data.
- &shy;<!-- .element: class="fragment" --> `system`: information about the chain.
- &shy;<!-- .element: class="fragment" --> `rpc`: information about the RPC endpoints.

<aside class="notes"><p>recall:</p>
<p><a href="https://docs.rs/sc-rpc-api/latest/sc_rpc_api/">https://docs.rs/sc-rpc-api/latest/sc_rpc_api/</a></p>
<ul>
<li>The full list can also be seen here: <a href="https://polkadot.js.org/docs/substrate/rpc/">https://polkadot.js.org/docs/substrate/rpc/</a></li>
<li>Specs: <a href="https://paritytech.github.io/json-rpc-interface-spec/introduction.html">https://paritytech.github.io/json-rpc-interface-spec/introduction.html</a></li>
<li>Upcoming changes to JSON-RPC api: <a href="https://forum.polkadot.network/t/new-json-rpc-api-mega-q-a/3048">https://forum.polkadot.network/t/new-json-rpc-api-mega-q-a/3048</a></li>
</ul>
</aside></script></section></section><section ><section data-markdown><script type="text/template">
## Workshop

We will do a transfer twice:

1. Once using the PJS-APPs.
2. Once manually using RPC.
</script></section><section data-markdown><script type="text/template">
## Workshop: Step 0

- Complete the steps in the README
- Open PJS-APPs and connect to your local node.

> Don't forget to run with `--tmp` flag.

- Ideas:

- Play with `--consensus`
- Try a `transfer`
</script></section><section data-markdown><script type="text/template">
### Workshop: Check balance

- Query current balance of Alice and Bob.

* To get the storage key: `Developer -> Extrinsics`
* `System -> Account`

```sh
wscat \
  -c ws://localhost:9944 \
  -x '{"jsonrpc":"2.0", "id": 42, "method":"state_getStorage", "params": [""] }' \
  | jq
```

<aside class="notes"><ul>
<li>You will learn how the storage key is calculated in FRAME based substrate chains in the FRAME
module.</li>
</ul>
</aside></script></section><section data-markdown><script type="text/template">
### Workshop: Metadata

- Recall type information is lost in SCALE encoded data.
- Substrate exposes type information using metadata.

```sh
wscat \
  -c ws://localhost:9944 \
  -x '{"jsonrpc":"2.0", "id": 42, "method":"state_getMetadata" }' \
  | jq
```

<br/>

- This itself is Scale Encoded. See [frame-metadata](https://github.com/paritytech/frame-metadata).
- Derive type of AccountInfo using this metadata.

<!-- .element: class="fragment" -->

<aside class="notes"><ul>
<li>Use PJS app to get frame-metadata: Developer &gt; RPC Calls &gt; state &gt; getMetadata.</li>
<li><a href="https://hackmd.io/@ak0n/rJUhmXmK6">Metadata</a> with most details not relevant stripped off.</li>
</ul>
<pre><code>{
  magicNumber: 1,635,018,093
  metadata: {
    V14: {
      lookup: {
        types: [
          {
            id: 3
            type: {
              path: [
                frame_system
                AccountInfo
              ]
              params: [
                {
                  name: Nonce
                  type: 4
                }
                {
                  name: AccountData
                  type: 5
                }
              ]
              def: {
                Composite: {
                  fields: [
                    {
                      name: nonce
                      type: 4
                      typeName: Nonce
                      docs: []
                    }
                    {
                      name: consumers
                      type: 4
                      typeName: RefCount
                      docs: []
                    }
                    {
                      name: providers
                      type: 4
                      typeName: RefCount
                      docs: []
                    }
                    {
                      name: sufficients
                      type: 4
                      typeName: RefCount
                      docs: []
                    }
                    {
                      name: data
                      type: 5
                      typeName: AccountData
                      docs: []
                    }
                  ]
                }
              }
              docs: []
            }
          }

          ..

          {
            id: 4
            type: {
              path: []
              params: []
              def: {
                Primitive: U32
              }
              docs: []
            }
          }

          ..

          {
            id: 5
            type: {
              path: [
                pallet_balances
                types
                AccountData
              ]
              params: [
                {
                  name: Balance
                  type: 6
                }
              ]
              def: {
                Composite: {
                  fields: [
                    {
                      name: free
                      type: 6
                      typeName: Balance
                      docs: []
                    }
                    {
                      name: reserved
                      type: 6
                      typeName: Balance
                      docs: []
                    }
                    {
                      name: frozen
                      type: 6
                      typeName: Balance
                      docs: []
                    }
                    {
                      name: flags
                      type: 7
                      typeName: ExtraFlags
                      docs: []
                    }
                  ]
                }
              }
              docs: []
            }
          }

          ..


          {
            id: 6
            type: {
              path: []
              params: []
              def: {
                Primitive: U64
              }
              docs: []
            }
          }

          ..

          {
            id: 7
            type: {
              path: [
                pallet_balances
                types
                ExtraFlags
              ]
              params: []
              def: {
                Composite: {
                  fields: [
                    {
                      name: null
                      type: 8
                      typeName: u128
                      docs: []
                    }
                  ]
                }
              }
              docs: []
            }
          }

          ..

          {
            id: 8
            type: {
              path: []
              params: []
              def: {
                Primitive: U128
              }
              docs: []
            }
          }

        ]
      }
      pallets: [],
      extrinsic: {},
      type: 107
    }
  }
}
</code></pre>
</aside></script></section><section data-markdown><script type="text/template">
### Workshop: Decoding balance

- Use [scale decoder](https://www.shawntabrizi.com/substrate-js-utilities/codec/) to decode balance.
- Use the following type information for AccountInfo.

```json
{
  "info": {
    "nonce": "u32",
    "ignore": "(u32, u32, u32)",
    "balance": {
      "free": "u64",
      "ignore": "(u64, u64, u128)"
    }
  }
}
```

<aside class="notes"><p>The actual type is:</p>
<pre><code class="language-json">{
  &quot;info&quot;: {
    &quot;nonce&quot;: &quot;u32&quot;,
    &quot;ignore&quot;: &quot;u32&quot;,
    &quot;providers&quot;: &quot;u32&quot;,
    &quot;sufficients&quot;: &quot;u32&quot;,
    &quot;balance&quot;: {
      &quot;free&quot;: &quot;u64&quot;,
      &quot;reserved&quot;: &quot;u64&quot;,
      &quot;frozen&quot;: &quot;u64&quot;,
      &quot;flags&quot;: &quot;u128&quot;
    }
  }
}
</code></pre>
</aside></script></section><section data-markdown><script type="text/template">
### Workshop: Transfer some tokens

- Take PJS help to get the signed extrinsic.
  - `Developer -> Extrinsics -> Balances -> Transfer`
- Use the following command to submit the extrinsic.

```sh
wscat \
  -c ws://localhost:9944 \
  -x '{"jsonrpc":"2.0", "id": 42, "method":"author_submitExtrinsic", "params": [""] }' \
  | jq
```

- Check balance again for both accounts.
- What happens to nonce of Alice?

<aside class="notes"><ul>
<li>Students will learn how to build the signed extrinsic themselves in their assignment.</li>
<li>Let students do the second part themselves.</li>
</ul>
</aside></script></section></section><section  data-markdown><script type="text/template">
### Workshop: Versions

- Find runtime version of the polkadot and westend chain `state_getRuntimeVersion`.
- Find node version of the polkadot and westend chain `system_version`.
- Change RPC provider and see if any of the above value changes?

<br/>

- For runtime version, you read `specVersion` : `1,005,000` as `1.5.0`.

<!-- .element: class="fragment" -->

<aside class="notes"><ul>
<li><code>wscat -c wss://polkadot-rpc.dwellir.com -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:1, &quot;method&quot;:&quot;state_getRuntimeVersion&quot;}&#39; | jq</code>.</li>
<li><code>wscat -c wss://polkadot-rpc.dwellir.com -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:1, &quot;method&quot;:&quot;system_version&quot;}&#39; | jq</code>.</li>
<li>Show polkadot telemetry: <a href="https://telemetry.polkadot.io/">https://telemetry.polkadot.io/</a>.</li>
</ul>
</aside></script></section><section  data-markdown><script type="text/template">
### JSON-RPC: Application

- On top of `SCALE` and `JSON-RPC`, a large array of libraries have been built.

- `PJS-API` / `PJS-APPS`
- future: `PAPI`
- `subxt`
- Any many more!
</script></section><section  data-markdown><script type="text/template">
## Additional Resources! 😋

> Check speaker notes (click "s" 😉)

<aside class="notes"><ul>
<li>see &quot;Client Libraries&quot; here: <a href="https://project-awesome.org/substrate-developer-hub/awesome-substrate">https://project-awesome.org/substrate-developer-hub/awesome-substrate</a></li>
<li><a href="https://paritytech.github.io/json-rpc-interface-spec/introduction.html">https://paritytech.github.io/json-rpc-interface-spec/introduction.html</a></li>
<li>Full subxt guide: <a href="https://docs.rs/subxt/latest/subxt/book/index.html">https://docs.rs/subxt/latest/subxt/book/index.html</a></li>
<li><a href="https://github.com/JFJun/go-substrate-rpc-client">https://github.com/JFJun/go-substrate-rpc-client</a></li>
<li><a href="https://github.com/polkascan/py-substrate-interface">https://github.com/polkascan/py-substrate-interface</a></li>
<li><a href="https://github.com/polkadot-api/polkadot-api">https://github.com/polkadot-api/polkadot-api</a></li>
<li>more here: <a href="https://project-awesome.org/substrate-developer-hub/awesome-substrate">https://project-awesome.org/substrate-developer-hub/awesome-substrate</a></li>
<li>Listen to James Wilson introducing subxt: <a href="https://www.youtube.com/watch?v=aFk6We_Ke1I">https://www.youtube.com/watch?v=aFk6We_Ke1I</a></li>
</ul>
</aside></script></section><section  data-markdown><script type="text/template">
### JSON-RPC: Mini Activity

In Kusama:

- Find the genesis hash..
- Number of extrinsics at block 10,000,000.
- The block number is stored under `twox128("System") ++ twox128("Number")`.
- Find it now, and at block 10,000,000.

<br/>

- Refer to the "Substrate; Show Me The Code" lecture to find the right RPC endpoints.
- You have 15 minutes!

<aside class="notes"><pre><code class="language-sh"># 10,000,000 in hex
printf &quot;%x\n&quot; 10000000
# Genesis hash
wscat -c wss://kusama-rpc.polkadot.io -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:72, &quot;method&quot;:&quot;chain_getBlockHash&quot;, &quot;params&quot;: [&quot;0x0&quot;] }&#39; | jq
# Hash of the block at height 10,000,000
wscat -c wss://kusama-rpc.polkadot.io -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:72, &quot;method&quot;:&quot;chain_getBlockHash&quot;, &quot;params&quot;: [&quot;0x989680&quot;] }&#39; | jq
# The block at height 1,000,000
wscat -c wss://kusama-rpc.polkadot.io -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:72, &quot;method&quot;:&quot;chain_getBlock&quot;, &quot;params&quot;: [&quot;0xdcbaa224ab080f2fbf3dfc85f3387ab21019355c392d79a143d7e50afba3c6e9&quot;] }&#39; | jq

# `0x26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac` now.
wscat -c wss://kusama-rpc.polkadot.io -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:72, &quot;method&quot;:&quot;state_getStorage&quot;, &quot;params&quot;: [&quot;0x26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac&quot;] }&#39; | jq
# `0x26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac` at block 1,000,000.
wscat -c wss://kusama-rpc.polkadot.io -x &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;, &quot;id&quot;:72, &quot;method&quot;:&quot;state_getStorage&quot;, &quot;params&quot;: [&quot;0x26aa394eea5630e07c48ae0c9558cef702a5c1b19ab7a04f536c519aca4983ac&quot;, &quot;0xdcbaa224ab080f2fbf3dfc85f3387ab21019355c392d79a143d7e50afba3c6e9&quot;] }&#39; | jq
</code></pre>
<p>Notice that this number that we get back is the little endian (SCALE) encoded value that we passed in at first.</p>
</aside></script></section><section  data-markdown><script type="text/template">
## `subxt`

- Something analogous to `PJS api` for Rust.
- The real magic is that it generates the types by fetching the metadata at compile time, or linking
  it statically.
- ..It might need manual updates when the code, and therefore the metadata changes.
</script></section>
    </article>
  </main>

  <script src="./../../../dist/reveal.js"></script>

  <script src="./../../../plugin/markdown/markdown.js"></script>
  <script src="./../../../plugin/highlight/highlight.js"></script>
  <script src="./../../../plugin/zoom/zoom.js"></script>
  <script src="./../../../plugin/notes/notes.js"></script>
  <script src="./../../../plugin/math/math.js"></script>

  <script src="./../../../assets/plugin/mermaid.js"></script>
  <script src="./../../../assets/plugin/mermaid-theme.js"></script>

  <script src="./../../../assets/plugin/chart/chart.js"></script>
  <script src="./../../../assets/plugin/chart/chart.min.js"></script>

  <script src="./../../../assets/plugin/tailwindcss.min.js"></script>

  <script>
    function extend() {
      var target = {};
      for (var i = 0; i < arguments.length; i++) {
        var source = arguments[i];
        for (var key in source) {
          if (source.hasOwnProperty(key)) {
            target[key] = source[key];
          }
        }
      }
      return target;
    }

    // default options to init reveal.js
    var defaultOptions = {
      controls: true,
      progress: true,
      history: true,
      center: true,
      transition: 'default', // none/fade/slide/convex/concave/zoom
      slideNumber: true,
      mermaid: {
        startOnLoad: false,
        logLevel: 3,
        theme: 'base',
        themeVariables: {
          primaryColor: purple,
          primaryTextColor: white,
          primaryBorderColor: pink,
          lineColor: pink,
          secondaryColor: lightPurple,
          tertiaryColor: lightPurple,
        },
      },
      chart: {
        defaults: {
          color: 'lightgray', // color of labels
          scale: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
            grid: { color: "lightgray" }, // color of grid lines
          },
        },
        line: { borderColor: ["#ccc", "#E6007A", "#6D3AEE"], "borderDash": [[5, 10], [0, 0]] },
        bar: { backgroundColor: ["#ccc", "#E6007A", "#6D3AEE"] },
      },
      plugins: [
        RevealMarkdown,
        RevealHighlight,
        RevealZoom,
        RevealNotes,
        RevealMath,
        RevealMermaid,
        RevealChart
      ]
    };

    // options from URL query string
    var queryOptions = Reveal().getQueryHash() || {};

    var options = extend(defaultOptions, {"width":1400,"height":900,"margin":0,"minScale":0.2,"maxScale":2,"transition":"none","controls":true,"progress":true,"center":true,"slideNumber":true,"backgroundTransition":"fade"}, queryOptions);
  </script>


  <script>
    Reveal.initialize(options);
  </script>
</body>

</html>
